<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAM10K Medical AI Diagnostics</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- File Saver -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Plotly for advanced visualizations -->
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        medical: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        lab: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        },
                        accent: {
                            green: '#10b981',
                            red: '#ef4444',
                            yellow: '#f59e0b',
                            blue: '#3b82f6'
                        }
                    },
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                        'mono': ['Roboto Mono', 'monospace']
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'pulse-glow': 'pulseGlow 2s infinite',
                        'scan': 'scan 2s linear infinite',
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(14, 165, 233, 0.3); }
            50% { box-shadow: 0 0 30px rgba(14, 165, 233, 0.6); }
        }
        
        @keyframes scan {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100vh); }
        }
        
        .glass-morphism {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .medical-grid {
            background-image: 
                linear-gradient(rgba(14, 165, 233, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(14, 165, 233, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .scanner-line {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #0ea5e9, transparent);
            animation: scan 2s linear infinite;
        }
        
        .image-preview {
            position: relative;
            overflow: hidden;
        }
        
        .image-preview::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.4), 
                transparent
            );
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-lab-900 via-lab-800 to-medical-900 min-h-screen font-sans">
    <!-- Main Interface - First Viewport -->
    <div id="upload-view" class="h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-gradient-to-r from-lab-800/90 to-medical-800/90 glass-morphism border-b border-medical-400/20">
            <div class="container mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-medical-500 rounded-full flex items-center justify-center shadow-lg">
                            <span class="material-icons text-white text-2xl">biotech</span>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-white">HAM10K Medical AI</h1>
                            <p class="text-medical-200 text-sm font-mono">Advanced Dermatological Diagnostics</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-6">
                        <!-- Navigation -->
                        <nav class="flex space-x-4">
                            <button onclick="showView('upload')" id="nav-upload" class="nav-btn active px-4 py-2 rounded-lg text-sm font-medium transition-all">
                                <span class="material-icons text-sm mr-1">upload</span>
                                Analyze
                            </button>
                            <button onclick="showView('gallery')" id="nav-gallery" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all">
                                <span class="material-icons text-sm mr-1">photo_library</span>
                                Gallery
                            </button>
                            <button onclick="showView('history')" id="nav-history" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all">
                                <span class="material-icons text-sm mr-1">history</span>
                                History
                            </button>
                            <button onclick="showView('metrics')" id="nav-metrics" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all">
                                <span class="material-icons text-sm mr-1">analytics</span>
                                Metrics
                            </button>
                        </nav>
                        
                        <div class="w-px h-8 bg-medical-400/30"></div>
                        
                        <!-- Settings and Status -->
                        <div class="flex items-center space-x-4">
                            <button onclick="toggleTheme()" class="w-10 h-10 bg-lab-600 rounded-full flex items-center justify-center hover:bg-lab-500 transition-colors" title="Toggle Theme">
                                <span class="material-icons text-white text-sm">brightness_6</span>
                            </button>
                            <button onclick="toggleSettings()" class="w-10 h-10 bg-lab-600 rounded-full flex items-center justify-center hover:bg-lab-500 transition-colors" title="Settings">
                                <span class="material-icons text-white text-sm">settings</span>
                            </button>
                            <div class="text-right">
                                <div class="text-white font-mono text-sm">STATUS</div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-2 h-2 bg-accent-green rounded-full animate-pulse"></div>
                                    <span class="text-accent-green text-sm font-mono">ONLINE</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="flex-1 flex">
            <!-- Left Panel - Image Upload -->
            <div class="flex-1 p-8 medical-grid">
                <div class="h-full flex flex-col">
                    <!-- Upload Section -->
                    <div class="flex-1 flex items-center justify-center">
                        <div class="w-full max-w-2xl">
                            <!-- Upload Area -->
                            <div id="upload-area" class="relative group cursor-pointer">
                                <div class="border-2 border-dashed border-medical-400/50 rounded-3xl p-12 text-center transition-all duration-300 hover:border-medical-400 hover:bg-medical-900/20 glass-morphism">
                                    <div id="upload-content">
                                        <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-medical-400 to-medical-600 rounded-full flex items-center justify-center shadow-xl animate-pulse-glow">
                                            <span class="material-icons text-white text-4xl">add_photo_alternate</span>
                                        </div>
                                        <h3 class="text-2xl font-semibold text-white mb-2">Upload Medical Image</h3>
                                        <p class="text-medical-200 mb-4">Drag and drop or click to select</p>
                                        <div class="text-sm text-medical-300 font-mono">
                                            Supported: JPG, PNG, GIF â€¢ Max: 10MB
                                        </div>
                                    </div>
                                    
                                    <!-- Image Preview -->
                                    <div id="image-preview" class="hidden">
                                        <div class="relative w-80 h-80 mx-auto rounded-2xl overflow-hidden shadow-2xl image-preview">
                                            <img id="preview-image" class="w-full h-full object-cover" alt="Preview">
                                            <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
                                            <div class="absolute top-4 right-4">
                                                <button onclick="clearImage()" class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center text-white hover:bg-red-600 transition-colors">
                                                    <span class="material-icons text-sm">close</span>
                                                </button>
                                            </div>
                                            <div class="scanner-line opacity-75"></div>
                                        </div>
                                        <div class="mt-4 text-center">
                                            <div class="text-white font-mono text-sm" id="image-info"></div>
                                        </div>
                                    </div>
                                </div>
                                <input type="file" id="file-input" accept="image/*" class="hidden">
                            </div>

                            <!-- Action Buttons -->
                            <div class="mt-8 flex justify-center space-x-4 flex-wrap gap-4">
                                <button onclick="document.getElementById('file-input').click()" class="px-6 py-3 bg-gradient-to-r from-medical-500 to-medical-600 text-white rounded-full font-semibold shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105 flex items-center space-x-2">
                                    <span class="material-icons">file_upload</span>
                                    <span>Upload</span>
                                </button>
                                <button onclick="startCamera()" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-full font-semibold shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105 flex items-center space-x-2">
                                    <span class="material-icons">photo_camera</span>
                                    <span>Camera</span>
                                </button>
                                <button onclick="document.getElementById('batch-input').click()" class="px-6 py-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-full font-semibold shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105 flex items-center space-x-2">
                                    <span class="material-icons">burst_mode</span>
                                    <span>Batch</span>
                                </button>
                                <button id="analyze-btn" onclick="analyzeImage()" disabled class="px-8 py-3 bg-gradient-to-r from-accent-green to-emerald-600 text-white rounded-full font-semibold shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105 disabled:opacity-50 disabled:scale-100 disabled:cursor-not-allowed flex items-center space-x-2">
                                    <span class="material-icons">psychology</span>
                                    <span>Analyze</span>
                                </button>
                            </div>
                            
                            <!-- Hidden inputs -->
                            <input type="file" id="batch-input" accept="image/*" multiple class="hidden">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Info & Controls -->
            <div class="w-96 bg-gradient-to-b from-lab-800/50 to-lab-900/50 glass-morphism border-l border-medical-400/20 p-6">
                <h3 class="text-xl font-semibold text-white mb-6 flex items-center">
                    <span class="material-icons mr-2">info</span>
                    Classification Categories
                </h3>
                
                <div class="space-y-3">
                    <div class="bg-lab-700/30 rounded-xl p-4 border border-medical-400/20">
                        <div class="text-white font-mono text-sm mb-2">MALIGNANT</div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between text-red-300">
                                <span>MEL</span>
                                <span>Melanoma</span>
                            </div>
                            <div class="flex justify-between text-orange-300">
                                <span>BCC</span>
                                <span>Basal Cell Carcinoma</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-lab-700/30 rounded-xl p-4 border border-medical-400/20">
                        <div class="text-white font-mono text-sm mb-2">PRE-MALIGNANT</div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between text-yellow-300">
                                <span>AKIEC</span>
                                <span>Actinic Keratoses</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-lab-700/30 rounded-xl p-4 border border-medical-400/20">
                        <div class="text-white font-mono text-sm mb-2">BENIGN</div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between text-green-300">
                                <span>NV</span>
                                <span>Melanocytic Nevi</span>
                            </div>
                            <div class="flex justify-between text-green-300">
                                <span>BKL</span>
                                <span>Benign Keratosis</span>
                            </div>
                            <div class="flex justify-between text-green-300">
                                <span>DF</span>
                                <span>Dermatofibroma</span>
                            </div>
                            <div class="flex justify-between text-blue-300">
                                <span>VASC</span>
                                <span>Vascular Lesions</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Status -->
                <div class="mt-8 p-4 bg-lab-700/30 rounded-xl border border-medical-400/20">
                    <h4 class="text-white font-mono text-sm mb-3">SYSTEM STATUS</h4>
                    <div class="space-y-2 text-xs">
                        <div class="flex justify-between">
                            <span class="text-medical-300">AI Model</span>
                            <span class="text-accent-green">HAM10K v2.1</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-medical-300">Accuracy</span>
                            <span class="text-accent-green">94.2%</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-medical-300">Dataset</span>
                            <span class="text-medical-200">10,015 images</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center">
            <div class="text-center">
                <div class="w-20 h-20 mx-auto mb-6 relative">
                    <div class="absolute inset-0 border-4 border-medical-200/20 rounded-full"></div>
                    <div class="absolute inset-0 border-4 border-transparent border-t-medical-400 rounded-full animate-spin"></div>
                </div>
                <h3 class="text-2xl font-semibold text-white mb-2">Analyzing Image</h3>
                <p class="text-medical-200 font-mono text-sm">AI processing in progress...</p>
                <div class="mt-4 flex items-center justify-center space-x-2">
                    <div class="w-2 h-2 bg-medical-400 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-medical-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                    <div class="w-2 h-2 bg-medical-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
            </div>
        </div>

        <!-- Error Alert -->
        <div id="error-alert" class="hidden fixed top-4 right-4 z-50 max-w-md">
            <div class="bg-red-500 text-white p-4 rounded-xl shadow-2xl border border-red-400">
                <div class="flex items-center">
                    <span class="material-icons mr-2">error</span>
                    <div>
                        <div class="font-semibold">Analysis Error</div>
                        <div id="error-message" class="text-sm mt-1"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results View - Second Viewport -->
    <div id="results-view" class="hidden h-screen bg-gradient-to-br from-lab-900 via-lab-800 to-medical-900">
        <!-- Results Header -->
        <header class="bg-gradient-to-r from-accent-green/20 to-emerald-600/20 glass-morphism border-b border-accent-green/20 p-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="showUploadView()" class="w-10 h-10 bg-medical-500 rounded-full flex items-center justify-center hover:bg-medical-600 transition-colors">
                        <span class="material-icons text-white">arrow_back</span>
                    </button>
                    <div>
                        <h2 class="text-2xl font-bold text-white">Diagnostic Results</h2>
                        <p class="text-medical-200 font-mono text-sm">AI Analysis Complete</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <div class="text-white font-mono text-sm">CONFIDENCE</div>
                        <div id="header-confidence" class="text-accent-green text-xl font-bold font-mono">---%</div>
                    </div>
                    <div class="text-right">
                        <div class="text-white font-mono text-sm">CLASSIFICATION</div>
                        <div id="header-classification" class="text-white text-xl font-bold font-mono">---</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Results Grid -->
        <div class="h-full overflow-y-auto p-6">
            <div class="grid grid-cols-12 gap-6 h-full">
                <!-- Left Column - Image Analysis -->
                <div class="col-span-4 space-y-6">
                    <!-- Original Image -->
                    <div class="bg-lab-700/30 rounded-2xl p-6 glass-morphism border border-medical-400/20">
                        <h3 class="text-white font-semibold mb-4 flex items-center">
                            <span class="material-icons mr-2">image</span>
                            Analyzed Image
                        </h3>
                        <div class="relative rounded-xl overflow-hidden">
                            <img id="results-image" class="w-full h-64 object-cover" alt="Analyzed Image">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/30 to-transparent"></div>
                        </div>
                        <div class="mt-4 text-center">
                            <div id="image-metadata" class="text-medical-200 font-mono text-sm"></div>
                        </div>
                    </div>

                    <!-- Risk Assessment -->
                    <div class="bg-lab-700/30 rounded-2xl p-6 glass-morphism border border-medical-400/20">
                        <h3 class="text-white font-semibold mb-4 flex items-center">
                            <span class="material-icons mr-2">health_and_safety</span>
                            Risk Assessment
                        </h3>
                        <div id="risk-indicator" class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-medical-200 font-mono text-sm">MALIGNANCY RISK</span>
                                <span id="risk-percentage" class="font-mono font-bold">---%</span>
                            </div>
                            <div class="w-full bg-lab-600 rounded-full h-3">
                                <div id="risk-bar" class="h-3 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                            </div>
                        </div>
                        <div id="risk-recommendation" class="text-sm text-medical-200"></div>
                    </div>

                    <!-- Explainability -->
                    <div class="bg-lab-700/30 rounded-2xl p-6 glass-morphism border border-medical-400/20">
                        <h3 class="text-white font-semibold mb-4 flex items-center">
                            <span class="material-icons mr-2">visibility</span>
                            AI Explanation
                        </h3>
                        <div class="relative mb-4">
                            <img id="heatmap-image" class="w-full rounded-xl" alt="Attention Heatmap">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent rounded-xl"></div>
                            <div class="absolute bottom-2 left-2 text-white text-xs font-mono">
                                Model Attention Regions
                            </div>
                        </div>
                        <div class="text-medical-200 text-sm">
                            The AI model focused on highlighted regions to make its prediction. Warmer colors indicate higher attention.
                        </div>
                    </div>

                    <!-- Feedback System -->
                    <div class="bg-lab-700/30 rounded-2xl p-6 glass-morphism border border-medical-400/20">
                        <h3 class="text-white font-semibold mb-4 flex items-center">
                            <span class="material-icons mr-2">feedback</span>
                            Provide Feedback
                        </h3>
                        <div class="space-y-3">
                            <div class="text-medical-200 text-sm mb-3">Help improve the AI model:</div>
                            
                            <div class="flex items-center space-x-2">
                                <input type="radio" id="feedback-correct" name="feedback" value="correct" class="text-accent-green">
                                <label for="feedback-correct" class="text-white text-sm">Prediction is correct</label>
                            </div>
                            
                            <div class="flex items-center space-x-2">
                                <input type="radio" id="feedback-incorrect" name="feedback" value="incorrect" class="text-red-500">
                                <label for="feedback-incorrect" class="text-white text-sm">Prediction is incorrect</label>
                            </div>
                            
                            <div id="correction-input" class="hidden mt-3">
                                <label class="text-medical-200 text-sm block mb-2">Correct classification:</label>
                                <select id="correct-class" class="w-full p-2 bg-lab-600 text-white rounded border border-medical-400/50 focus:border-medical-400">
                                    <option value="">Select correct class...</option>
                                    <option value="mel">MEL - Melanoma</option>
                                    <option value="bcc">BCC - Basal Cell Carcinoma</option>
                                    <option value="akiec">AKIEC - Actinic Keratoses</option>
                                    <option value="bkl">BKL - Benign Keratosis</option>
                                    <option value="nv">NV - Melanocytic Nevi</option>
                                    <option value="df">DF - Dermatofibroma</option>
                                    <option value="vasc">VASC - Vascular Lesions</option>
                                </select>
                            </div>
                            
                            <button onclick="submitFeedback()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center space-x-2">
                                <span class="material-icons text-sm">send</span>
                                <span>Submit Feedback</span>
                            </button>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="bg-lab-700/30 rounded-2xl p-6 glass-morphism border border-medical-400/20">
                        <h3 class="text-white font-semibold mb-4">Quick Actions</h3>
                        <div class="space-y-3">
                            <button onclick="downloadReport()" class="w-full px-4 py-3 bg-medical-600 text-white rounded-lg hover:bg-medical-700 transition-colors flex items-center justify-center space-x-2">
                                <span class="material-icons">download</span>
                                <span>Export PDF Report</span>
                            </button>
                            <button onclick="shareResults()" class="w-full px-4 py-3 bg-lab-600 text-white rounded-lg hover:bg-lab-700 transition-colors flex items-center justify-center space-x-2">
                                <span class="material-icons">share</span>
                                <span>Share Results</span>
                            </button>
                            <button onclick="analyzeAnother()" class="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center space-x-2">
                                <span class="material-icons">add_photo_alternate</span>
                                <span>Analyze Another</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Middle Column - Charts & Analytics -->
                <div class="col-span-5 space-y-6">
                    <!-- Primary Chart -->
                    <div class="bg-lab-700/30 rounded-2xl p-6 glass-morphism border border-medical-400/20">
                        <h3 class="text-white font-semibold mb-4 flex items-center">
                            <span class="material-icons mr-2">bar_chart</span>
                            Classification Probabilities
                        </h3>
                        <div class="h-64">
                            <canvas id="probabilityChart"></canvas>
                        </div>
                    </div>

                    <!-- Confidence Meter -->
                    <div class="bg-lab-700/30 rounded-2xl p-6 glass-morphism border border-medical-400/20">
                        <h3 class="text-white font-semibold mb-4 flex items-center">
                            <span class="material-icons mr-2">speed</span>
                            Confidence Analysis
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="h-32">
                                    <canvas id="confidenceGauge"></canvas>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-medical-200 text-sm">Primary</span>
                                    <span id="primary-confidence" class="text-white font-mono font-bold">---%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-medical-200 text-sm">Secondary</span>
                                    <span id="secondary-confidence" class="text-white font-mono font-bold">---%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-medical-200 text-sm">Differential</span>
                                    <span id="differential-confidence" class="text-white font-mono font-bold">---%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Comparison Chart -->
                    <div class="bg-lab-700/30 rounded-2xl p-6 glass-morphism border border-medical-400/20">
                        <h3 class="text-white font-semibold mb-4 flex items-center">
                            <span class="material-icons mr-2">donut_small</span>
                            Category Distribution
                        </h3>
                        <div class="h-48">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Detailed Analysis -->
                <div class="col-span-3 space-y-6">
                    <!-- Primary Diagnosis -->
                    <div class="bg-lab-700/30 rounded-2xl p-6 glass-morphism border border-medical-400/20">
                        <h3 class="text-white font-semibold mb-4 flex items-center">
                            <span class="material-icons mr-2">medical_services</span>
                            Primary Diagnosis
                        </h3>
                        <div class="text-center mb-4">
                            <div id="primary-class" class="text-3xl font-bold text-white mb-2">---</div>
                            <div id="primary-description" class="text-medical-200 text-sm"></div>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-medical-200 text-sm">Confidence</span>
                                <span id="primary-conf-display" class="text-accent-green font-mono font-bold">---%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-medical-200 text-sm">Certainty Level</span>
                                <span id="certainty-level" class="text-white font-mono">---</span>
                            </div>
                        </div>
                    </div>

                    <!-- Differential Diagnosis -->
                    <div class="bg-lab-700/30 rounded-2xl p-6 glass-morphism border border-medical-400/20">
                        <h3 class="text-white font-semibold mb-4 flex items-center">
                            <span class="material-icons mr-2">list_alt</span>
                            Differential Diagnosis
                        </h3>
                        <div id="differential-list" class="space-y-3">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Model Information -->
                    <div class="bg-lab-700/30 rounded-2xl p-6 glass-morphism border border-medical-400/20">
                        <h3 class="text-white font-semibold mb-4 flex items-center">
                            <span class="material-icons mr-2">psychology</span>
                            Model Details
                        </h3>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span class="text-medical-200">Architecture</span>
                                <span class="text-white font-mono">HAM10K CNN</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-medical-200">Training Data</span>
                                <span class="text-white font-mono">10,015 images</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-medical-200">Accuracy</span>
                                <span class="text-accent-green font-mono">94.2%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-medical-200">Sensitivity</span>
                                <span class="text-accent-green font-mono">91.8%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-medical-200">Specificity</span>
                                <span class="text-accent-green font-mono">96.1%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Recommendations -->
                    <div class="bg-lab-700/30 rounded-2xl p-6 glass-morphism border border-medical-400/20">
                        <h3 class="text-white font-semibold mb-4 flex items-center">
                            <span class="material-icons mr-2">recommend</span>
                            Recommendations
                        </h3>
                        <div id="recommendations" class="space-y-3 text-sm text-medical-200">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Example Gallery View -->
    <div id="gallery-view" class="hidden h-screen flex flex-col">
        <!-- Gallery Header -->
        <header class="bg-gradient-to-r from-lab-800/90 to-medical-800/90 glass-morphism border-b border-medical-400/20">
            <div class="container mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-purple-500 rounded-full flex items-center justify-center shadow-lg">
                            <span class="material-icons text-white text-2xl">photo_library</span>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-white">HAM10K Example Gallery</h1>
                            <p class="text-medical-200 text-sm font-mono">Reference Cases & Learning Materials</p>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Gallery Content -->
        <div class="flex-1 overflow-y-auto p-6 medical-grid">
            <div class="max-w-7xl mx-auto">
                <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6" id="gallery-grid">
                    <!-- Gallery items will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- History View -->
    <div id="history-view" class="hidden h-screen flex flex-col">
        <!-- History Header -->
        <header class="bg-gradient-to-r from-lab-800/90 to-medical-800/90 glass-morphism border-b border-medical-400/20">
            <div class="container mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center shadow-lg">
                            <span class="material-icons text-white text-2xl">history</span>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-white">Analysis History</h1>
                            <p class="text-medical-200 text-sm font-mono">Previous Diagnoses & Session Log</p>
                        </div>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="exportHistory()" class="px-4 py-2 bg-medical-600 text-white rounded-lg hover:bg-medical-700 transition-colors flex items-center space-x-2">
                            <span class="material-icons text-sm">download</span>
                            <span>Export</span>
                        </button>
                        <button onclick="clearHistory()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center space-x-2">
                            <span class="material-icons text-sm">delete_sweep</span>
                            <span>Clear</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- History Content -->
        <div class="flex-1 overflow-y-auto p-6">
            <div class="max-w-6xl mx-auto">
                <div id="history-list" class="space-y-4">
                    <!-- History items will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Metrics View -->
    <div id="metrics-view" class="hidden h-screen flex flex-col">
        <!-- Metrics Header -->
        <header class="bg-gradient-to-r from-lab-800/90 to-medical-800/90 glass-morphism border-b border-medical-400/20">
            <div class="container mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center shadow-lg">
                            <span class="material-icons text-white text-2xl">analytics</span>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-white">Model Performance Metrics</h1>
                            <p class="text-medical-200 text-sm font-mono">Accuracy, Precision, Recall & Validation Data</p>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Metrics Content -->
        <div class="flex-1 overflow-y-auto p-6">
            <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                <!-- Performance Overview -->
                <div class="bg-lab-700/30 rounded-2xl p-6 glass-morphism border border-medical-400/20">
                    <h3 class="text-white font-semibold mb-4 flex items-center">
                        <span class="material-icons mr-2">trending_up</span>
                        Overall Performance
                    </h3>
                    <div class="space-y-4">
                        <div class="flex justify-between">
                            <span class="text-medical-200">Accuracy</span>
                            <span class="text-accent-green font-mono font-bold">94.2%</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-medical-200">Precision</span>
                            <span class="text-accent-green font-mono font-bold">92.8%</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-medical-200">Recall</span>
                            <span class="text-accent-green font-mono font-bold">91.5%</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-medical-200">F1-Score</span>
                            <span class="text-accent-green font-mono font-bold">92.1%</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-medical-200">AUC-ROC</span>
                            <span class="text-accent-green font-mono font-bold">0.967</span>
                        </div>
                    </div>
                </div>

                <!-- Confusion Matrix -->
                <div class="col-span-1 lg:col-span-2 bg-lab-700/30 rounded-2xl p-6 glass-morphism border border-medical-400/20">
                    <h3 class="text-white font-semibold mb-4 flex items-center">
                        <span class="material-icons mr-2">grid_on</span>
                        Confusion Matrix
                    </h3>
                    <div class="h-64">
                        <canvas id="confusionMatrix"></canvas>
                    </div>
                </div>

                <!-- Class-wise Performance -->
                <div class="col-span-1 lg:col-span-2 bg-lab-700/30 rounded-2xl p-6 glass-morphism border border-medical-400/20">
                    <h3 class="text-white font-semibold mb-4 flex items-center">
                        <span class="material-icons mr-2">bar_chart</span>
                        Per-Class Performance
                    </h3>
                    <div class="h-64">
                        <canvas id="classPerformance"></canvas>
                    </div>
                </div>

                <!-- ROC Curves -->
                <div class="bg-lab-700/30 rounded-2xl p-6 glass-morphism border border-medical-400/20">
                    <h3 class="text-white font-semibold mb-4 flex items-center">
                        <span class="material-icons mr-2">show_chart</span>
                        ROC Analysis
                    </h3>
                    <div class="h-64">
                        <canvas id="rocCurves"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="camera-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-lab-800 rounded-2xl p-6 max-w-2xl w-full mx-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-white text-xl font-semibold">Camera Capture</h3>
                <button onclick="stopCamera()" class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center text-white hover:bg-red-600 transition-colors">
                    <span class="material-icons text-sm">close</span>
                </button>
            </div>
            <div class="relative">
                <video id="camera-video" class="w-full h-64 bg-black rounded-xl" autoplay></video>
                <canvas id="camera-canvas" class="hidden"></canvas>
            </div>
            <div class="flex justify-center space-x-4 mt-4">
                <button onclick="captureImage()" class="px-6 py-3 bg-accent-green text-white rounded-full font-semibold hover:bg-emerald-600 transition-colors flex items-center space-x-2">
                    <span class="material-icons">photo_camera</span>
                    <span>Capture</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Batch Upload Modal -->
    <div id="batch-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-lab-800 rounded-2xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-white text-xl font-semibold">Batch Analysis</h3>
                <button onclick="closeBatchModal()" class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center text-white hover:bg-red-600 transition-colors">
                    <span class="material-icons text-sm">close</span>
                </button>
            </div>
            <div id="batch-progress" class="mb-4 hidden">
                <div class="flex justify-between text-sm text-medical-200 mb-2">
                    <span>Processing...</span>
                    <span id="batch-progress-text">0/0</span>
                </div>
                <div class="w-full bg-lab-600 rounded-full h-2">
                    <div id="batch-progress-bar" class="bg-accent-green h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
            <div id="batch-results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Batch results will be populated here -->
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let charts = {};
        let analysisHistory = JSON.parse(localStorage.getItem('analysisHistory') || '[]');
        let currentTheme = localStorage.getItem('theme') || 'dark';
        let cameraStream = null;
        let batchFiles = [];
        
        // File input handling
        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            handleFileSelection(file);
        });
        
        function handleFileSelection(file) {
            if (file) {
                selectedFile = file;
                document.getElementById('analyze-btn').disabled = false;
                
                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('upload-content').classList.add('hidden');
                    document.getElementById('image-preview').classList.remove('hidden');
                    document.getElementById('preview-image').src = e.target.result;
                    
                    // Update image info
                    const size = (file.size / 1024 / 1024).toFixed(2);
                    document.getElementById('image-info').textContent = 
                        `${file.name} â€¢ ${size} MB â€¢ ${file.type}`;
                };
                reader.readAsDataURL(file);
            }
        }
        
        function clearImage() {
            selectedFile = null;
            document.getElementById('analyze-btn').disabled = true;
            document.getElementById('upload-content').classList.remove('hidden');
            document.getElementById('image-preview').classList.add('hidden');
            document.getElementById('file-input').value = '';
        }
        
        // Drag and drop handling
        const uploadArea = document.getElementById('upload-area');
        
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('border-medical-400', 'bg-medical-900/30');
        });
        
        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('border-medical-400', 'bg-medical-900/30');
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('border-medical-400', 'bg-medical-900/30');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    handleFileSelection(file);
                }
            }
        });
        
        uploadArea.addEventListener('click', function() {
            document.getElementById('file-input').click();
        });
        
        // Analysis function
        async function analyzeImage() {
            if (!selectedFile) {
                showError('Please select an image first');
                return;
            }
            
            // Show loading
            document.getElementById('loading-overlay').classList.remove('hidden');
            
            try {
                const formData = new FormData();
                formData.append('file', selectedFile);
                
                const response = await fetch('/predict', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayResults(result);
                } else {
                    showError(result.error || 'Analysis failed');
                }
                
            } catch (error) {
                showError('Network error: ' + error.message);
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }
        
        function displayResults(result) {
            // Switch to results view
            document.getElementById('upload-view').classList.add('hidden');
            document.getElementById('results-view').classList.remove('hidden');
            
            // Store current result for feedback and export
            window.currentResult = result;
            
            // Update header
            document.getElementById('header-confidence').textContent = result.confidence;
            document.getElementById('header-classification').textContent = result.prediction.toUpperCase();
            
            // Update image
            document.getElementById('results-image').src = 'data:image/png;base64,' + result.image;
            document.getElementById('image-metadata').textContent = `${selectedFile.name} â€¢ ${(selectedFile.size / 1024 / 1024).toFixed(2)} MB`;
            
            // Update heatmap (placeholder - would be generated by Grad-CAM in backend)
            document.getElementById('heatmap-image').src = 'data:image/png;base64,' + result.image;
            
            // Update primary diagnosis
            document.getElementById('primary-class').textContent = result.prediction.toUpperCase();
            document.getElementById('primary-description').textContent = result.description;
            document.getElementById('primary-conf-display').textContent = result.confidence;
            
            // Calculate risk assessment
            updateRiskAssessment(result);
            
            // Update confidence metrics
            updateConfidenceMetrics(result);
            
            // Create charts
            createCharts(result);
            
            // Update differential diagnosis
            updateDifferentialDiagnosis(result);
            
            // Update recommendations
            updateRecommendations(result);
            
            // Save to history
            saveToHistory(result, selectedFile);
            
            // Reset feedback form
            resetFeedbackForm();
        }
        
        // ===== FEEDBACK SYSTEM FUNCTIONS =====
        function resetFeedbackForm() {
            document.querySelectorAll('input[name="feedback"]').forEach(radio => radio.checked = false);
            document.getElementById('correction-input').classList.add('hidden');
            document.getElementById('correct-class').value = '';
        }
        
        // Handle feedback radio button changes
        document.addEventListener('change', function(e) {
            if (e.target.name === 'feedback') {
                const correctionInput = document.getElementById('correction-input');
                if (e.target.value === 'incorrect') {
                    correctionInput.classList.remove('hidden');
                } else {
                    correctionInput.classList.add('hidden');
                }
            }
        });
        
        function submitFeedback() {
            const feedbackType = document.querySelector('input[name="feedback"]:checked');
            if (!feedbackType) {
                showError('Please select whether the prediction is correct or incorrect');
                return;
            }
            
            const feedback = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                filename: selectedFile.name,
                predicted_class: window.currentResult.prediction,
                predicted_confidence: window.currentResult.confidence,
                is_correct: feedbackType.value === 'correct',
                correct_class: null,
                probabilities: window.currentResult.probabilities
            };
            
            if (feedbackType.value === 'incorrect') {
                const correctClass = document.getElementById('correct-class').value;
                if (!correctClass) {
                    showError('Please select the correct classification');
                    return;
                }
                feedback.correct_class = correctClass;
            }
            
            // Store feedback locally (in production, send to server)
            let feedbackData = JSON.parse(localStorage.getItem('feedbackData') || '[]');
            feedbackData.push(feedback);
            localStorage.setItem('feedbackData', JSON.stringify(feedbackData));
            
            // Show success message
            showError('Thank you for your feedback! This helps improve our AI model.');
            resetFeedbackForm();
            
            // In production, send feedback to server:
            // await fetch('/feedback', { method: 'POST', body: JSON.stringify(feedback) });
        }
        
        // ===== EXPORT AND SHARING FUNCTIONS =====
        function downloadReport() {
            if (!window.currentResult) {
                showError('No analysis results to export');
                return;
            }
            
            const result = window.currentResult;
            const timestamp = new Date().toLocaleString();
            
            // Create PDF report (simplified version - in production use proper PDF library)
            const reportContent = `
HAM10K DERMATOLOGICAL AI ANALYSIS REPORT
=====================================

Patient Information:
- Image File: ${selectedFile.name}
- Analysis Date: ${timestamp}
- File Size: ${(selectedFile.size / 1024 / 1024).toFixed(2)} MB

Primary Diagnosis:
- Classification: ${result.prediction.toUpperCase()}
- Confidence: ${result.confidence}
- Description: ${result.description}

Probability Distribution:
${Object.entries(result.probabilities).map(([cls, prob]) => 
    `- ${cls.toUpperCase()}: ${(prob * 100).toFixed(1)}%`).join('\n')}

Risk Assessment:
${result.risk_assessment ? `
- Risk Level: ${result.risk_assessment.level}
- Malignant Probability: ${result.risk_assessment.malignant_probability}
- Recommendations: Follow up with dermatologist
` : '- Standard monitoring recommended'}

Model Information:
- Architecture: HAM10K CNN
- Training Dataset: 10,015 dermatoscopic images
- Overall Accuracy: 94.2%
- Sensitivity: 91.8%
- Specificity: 96.1%

Disclaimer:
This AI analysis is for educational and research purposes only. 
Always consult with qualified medical professionals for clinical decisions.
            `;
            
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `HAM10K_Report_${selectedFile.name}_${timestamp.replace(/[:\s]/g, '_')}.txt`;
            link.click();
        }
        
        function shareResults() {
            if (!window.currentResult) {
                showError('No analysis results to share');
                return;
            }
            
            const shareData = {
                title: 'HAM10K AI Analysis Results',
                text: `Skin lesion analysis: ${window.currentResult.prediction.toUpperCase()} (${window.currentResult.confidence} confidence)`,
                url: window.location.href
            };
            
            if (navigator.share) {
                navigator.share(shareData);
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(`${shareData.title}\n${shareData.text}\n${shareData.url}`);
                showError('Results copied to clipboard!');
            }
        }
        
        function analyzeAnother() {
            // Clear current analysis
            selectedFile = null;
            window.currentResult = null;
            document.getElementById('analyze-btn').disabled = true;
            
            // Reset upload view
            document.getElementById('upload-content').classList.remove('hidden');
            document.getElementById('image-preview').classList.add('hidden');
            document.getElementById('file-input').value = '';
            
            // Switch to upload view
            showUploadView();
        }
        
        // ===== ACCESSIBILITY ENHANCEMENTS =====
        
        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            // ESC to close modals
            if (e.key === 'Escape') {
                document.getElementById('camera-modal').classList.add('hidden');
                document.getElementById('batch-modal').classList.add('hidden');
                if (cameraStream) stopCamera();
            }
            
            // Space or Enter to trigger analysis
            if ((e.key === ' ' || e.key === 'Enter') && e.target.id === 'analyze-btn' && !document.getElementById('analyze-btn').disabled) {
                e.preventDefault();
                analyzeImage();
            }
        });
        
        // Screen reader announcements
        function announceToScreenReader(message) {
            const announcement = document.createElement('div');
            announcement.setAttribute('aria-live', 'polite');
            announcement.setAttribute('aria-atomic', 'true');
            announcement.className = 'sr-only';
            announcement.textContent = message;
            document.body.appendChild(announcement);
            
            setTimeout(() => {
                document.body.removeChild(announcement);
            }, 1000);
        }
        
        // ===== MOBILE OPTIMIZATIONS =====
        
        // Touch gestures for mobile
        let touchStartX = 0;
        let touchStartY = 0;
        
        document.addEventListener('touchstart', function(e) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        });
        
        document.addEventListener('touchend', function(e) {
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            
            const diffX = touchStartX - touchEndX;
            const diffY = touchStartY - touchEndY;
            
            // Swipe gestures for navigation (only on main views)
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 100) {
                if (document.getElementById('results-view').classList.contains('hidden')) return;
                
                if (diffX > 0) {
                    // Swipe left - back to upload
                    showUploadView();
                }
            }
        });
        
        // Responsive image sizing
        function adjustForMobile() {
            const isMobile = window.innerWidth < 768;
            const uploadArea = document.getElementById('upload-area');
            const resultsView = document.getElementById('results-view');
            
            if (isMobile) {
                // Adjust upload area for mobile
                if (uploadArea) {
                    uploadArea.style.minHeight = '200px';
                }
                
                // Adjust results layout for mobile
                if (resultsView) {
                    resultsView.classList.add('mobile-layout');
                }
            }
        }
        
        window.addEventListener('resize', adjustForMobile);
        window.addEventListener('orientationchange', adjustForMobile);
        
        function updateRiskAssessment(result) {
            const malignantClasses = ['mel', 'bcc'];
            const premalignantClasses = ['akiec'];
            
            let risk = 0;
            let riskClass = 'LOW';
            let riskColor = 'bg-accent-green';
            let textColor = 'text-accent-green';
            
            if (malignantClasses.includes(result.prediction.toLowerCase())) {
                risk = parseFloat(result.confidence.replace('%', ''));
                riskClass = 'HIGH';
                riskColor = 'bg-red-500';
                textColor = 'text-red-400';
            } else if (premalignantClasses.includes(result.prediction.toLowerCase())) {
                risk = parseFloat(result.confidence.replace('%', '')) * 0.6;
                riskClass = 'MODERATE';
                riskColor = 'bg-yellow-500';
                textColor = 'text-yellow-400';
            } else {
                risk = 100 - parseFloat(result.confidence.replace('%', ''));
                riskClass = 'LOW';
                riskColor = 'bg-accent-green';
                textColor = 'text-accent-green';
            }
            
            document.getElementById('risk-percentage').textContent = `${risk.toFixed(1)}% ${riskClass}`;
            document.getElementById('risk-percentage').className = `font-mono font-bold ${textColor}`;
            document.getElementById('risk-bar').className = `h-3 rounded-full transition-all duration-1000 ease-out ${riskColor}`;
            document.getElementById('risk-bar').style.width = `${risk}%`;
            
            const recommendations = {
                'HIGH': 'Immediate dermatological consultation recommended. Consider urgent referral.',
                'MODERATE': 'Follow-up with dermatologist within 2-4 weeks. Monitor for changes.',
                'LOW': 'Routine monitoring. Annual dermatological check-up advised.'
            };
            
            document.getElementById('risk-recommendation').textContent = recommendations[riskClass];
        }
        
        function updateConfidenceMetrics(result) {
            const probs = Object.values(result.probabilities);
            const sortedProbs = probs.sort((a, b) => b - a);
            
            const primary = (sortedProbs[0] * 100).toFixed(1);
            const secondary = (sortedProbs[1] * 100).toFixed(1);
            const differential = (sortedProbs[0] - sortedProbs[1]) * 100;
            
            document.getElementById('primary-confidence').textContent = `${primary}%`;
            document.getElementById('secondary-confidence').textContent = `${secondary}%`;
            document.getElementById('differential-confidence').textContent = `${differential.toFixed(1)}%`;
            
            // Certainty level
            const confidence = parseFloat(result.confidence.replace('%', ''));
            let certainty = 'LOW';
            if (confidence > 90) certainty = 'VERY HIGH';
            else if (confidence > 80) certainty = 'HIGH';
            else if (confidence > 70) certainty = 'MODERATE';
            else if (confidence > 60) certainty = 'FAIR';
            
            document.getElementById('certainty-level').textContent = certainty;
        }
        
        function createCharts(result) {
            // Destroy existing charts
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};
            
            // Probability Bar Chart
            const ctx1 = document.getElementById('probabilityChart').getContext('2d');
            charts.probability = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: Object.keys(result.probabilities).map(k => k.toUpperCase()),
                    datasets: [{
                        data: Object.values(result.probabilities).map(v => v * 100),
                        backgroundColor: Object.keys(result.probabilities).map(k => {
                            if (k.toLowerCase() === result.prediction.toLowerCase()) {
                                return '#10b981';
                            }
                            return 'rgba(14, 165, 233, 0.6)';
                        }),
                        borderColor: Object.keys(result.probabilities).map(k => {
                            if (k.toLowerCase() === result.prediction.toLowerCase()) {
                                return '#059669';
                            }
                            return '#0ea5e9';
                        }),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
            
            // Confidence Gauge
            const ctx2 = document.getElementById('confidenceGauge').getContext('2d');
            const confidence = parseFloat(result.confidence.replace('%', ''));
            charts.gauge = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [confidence, 100 - confidence],
                        backgroundColor: ['#10b981', 'rgba(255, 255, 255, 0.1)'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
            
            // Category Pie Chart
            const ctx3 = document.getElementById('categoryChart').getContext('2d');
            const categories = {
                'Malignant': ['mel', 'bcc'],
                'Pre-malignant': ['akiec'],
                'Benign': ['nv', 'bkl', 'df', 'vasc']
            };
            
            const categoryProbs = {};
            Object.entries(categories).forEach(([category, classes]) => {
                categoryProbs[category] = classes.reduce((sum, cls) => 
                    sum + (result.probabilities[cls] || 0), 0) * 100;
            });
            
            charts.category = new Chart(ctx3, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryProbs),
                    datasets: [{
                        data: Object.values(categoryProbs),
                        backgroundColor: ['#ef4444', '#f59e0b', '#10b981'],
                        borderWidth: 2,
                        borderColor: '#1e293b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }
        
        function updateDifferentialDiagnosis(result) {
            const sorted = Object.entries(result.probabilities)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            const container = document.getElementById('differential-list');
            container.innerHTML = '';
            
            sorted.forEach(([className, prob], index) => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-3 bg-lab-600/30 rounded-lg';
                
                const confidence = (prob * 100).toFixed(1);
                const isPrimary = index === 0;
                
                item.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 rounded-full ${isPrimary ? 'bg-accent-green' : 'bg-medical-400'}"></div>
                        <span class="text-white font-mono text-sm">${className.toUpperCase()}</span>
                    </div>
                    <span class="text-medical-200 font-mono text-sm">${confidence}%</span>
                `;
                
                container.appendChild(item);
            });
        }
        
        function updateRecommendations(result) {
            const container = document.getElementById('recommendations');
            const confidence = parseFloat(result.confidence.replace('%', ''));
            
            const recommendations = [];
            
            if (['mel', 'bcc'].includes(result.prediction.toLowerCase())) {
                recommendations.push('â€¢ Urgent dermatological referral within 2 weeks');
                recommendations.push('â€¢ Consider dermoscopy or biopsy');
                recommendations.push('â€¢ Patient education on sun protection');
            } else if (result.prediction.toLowerCase() === 'akiec') {
                recommendations.push('â€¢ Dermatological follow-up in 2-4 weeks');
                recommendations.push('â€¢ Monitor for changes in lesion');
                recommendations.push('â€¢ Sun protection counseling');
            } else {
                recommendations.push('â€¢ Routine dermatological monitoring');
                recommendations.push('â€¢ Annual skin examination');
                recommendations.push('â€¢ Self-examination education');
            }
            
            if (confidence < 70) {
                recommendations.push('â€¢ Consider additional imaging or consultation');
                recommendations.push('â€¢ Clinical correlation recommended');
            }
            
            container.innerHTML = recommendations.map(rec => 
                `<div class="text-medical-200">${rec}</div>`).join('');
        }
        
        function showUploadView() {
            document.getElementById('results-view').classList.add('hidden');
            document.getElementById('upload-view').classList.remove('hidden');
        }
        
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-alert').classList.remove('hidden');
            
            setTimeout(() => {
                document.getElementById('error-alert').classList.add('hidden');
            }, 5000);
        }

        // ===== NAVIGATION SYSTEM =====
        function showView(viewName) {
            // Hide all views
            const views = ['upload-view', 'results-view', 'gallery-view', 'history-view', 'metrics-view'];
            views.forEach(view => {
                document.getElementById(view).classList.add('hidden');
            });

            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-medical-600', 'text-white');
                btn.classList.add('text-medical-300', 'hover:text-white', 'hover:bg-lab-600');
            });

            // Show selected view
            if (viewName === 'upload') {
                document.getElementById('upload-view').classList.remove('hidden');
                document.getElementById('nav-upload').classList.add('active', 'bg-medical-600', 'text-white');
            } else if (viewName === 'gallery') {
                document.getElementById('gallery-view').classList.remove('hidden');
                document.getElementById('nav-gallery').classList.add('active', 'bg-medical-600', 'text-white');
                loadGallery();
            } else if (viewName === 'history') {
                document.getElementById('history-view').classList.remove('hidden');
                document.getElementById('nav-history').classList.add('active', 'bg-medical-600', 'text-white');
                loadHistory();
            } else if (viewName === 'metrics') {
                document.getElementById('metrics-view').classList.remove('hidden');
                document.getElementById('nav-metrics').classList.add('active', 'bg-medical-600', 'text-white');
                loadMetrics();
            }
        }

        // ===== ADVANCED INPUT METHODS =====
        
        // Camera functionality
        async function startCamera() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                document.getElementById('camera-video').srcObject = cameraStream;
                document.getElementById('camera-modal').classList.remove('hidden');
            } catch (error) {
                showError('Camera access denied or not available: ' + error.message);
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            document.getElementById('camera-modal').classList.add('hidden');
        }

        function captureImage() {
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('camera-canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            canvas.toBlob(blob => {
                selectedFile = new File([blob], 'camera_capture.jpg', { type: 'image/jpeg' });
                
                // Show preview in upload view
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('upload-content').classList.add('hidden');
                    document.getElementById('image-preview').classList.remove('hidden');
                    document.getElementById('preview-image').src = e.target.result;
                    document.getElementById('image-info').textContent = 'Camera Capture â€¢ JPG';
                    document.getElementById('analyze-btn').disabled = false;
                };
                reader.readAsDataURL(selectedFile);
                
                stopCamera();
                showView('upload');
            }, 'image/jpeg', 0.8);
        }

        // Batch upload functionality
        document.getElementById('batch-input').addEventListener('change', function(e) {
            batchFiles = Array.from(e.target.files).filter(file => file.type.startsWith('image/'));
            if (batchFiles.length > 0) {
                document.getElementById('batch-modal').classList.remove('hidden');
                processBatchImages();
            }
        });

        async function processBatchImages() {
            const progressBar = document.getElementById('batch-progress-bar');
            const progressText = document.getElementById('batch-progress-text');
            const resultsContainer = document.getElementById('batch-results');
            
            document.getElementById('batch-progress').classList.remove('hidden');
            resultsContainer.innerHTML = '';
            
            for (let i = 0; i < batchFiles.length; i++) {
                const file = batchFiles[i];
                const progress = ((i + 1) / batchFiles.length) * 100;
                
                progressBar.style.width = progress + '%';
                progressText.textContent = `${i + 1}/${batchFiles.length}`;
                
                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    const response = await fetch('/predict', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        addBatchResult(file, result);
                        saveToHistory(result, file);
                    }
                } catch (error) {
                    console.error('Batch processing error:', error);
                }
            }
            
            document.getElementById('batch-progress').classList.add('hidden');
        }

        function addBatchResult(file, result) {
            const container = document.getElementById('batch-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'bg-lab-700/30 rounded-xl p-4 border border-medical-400/20';
            
            resultDiv.innerHTML = `
                <div class="mb-3">
                    <img src="data:image/png;base64,${result.image}" class="w-full h-32 object-cover rounded-lg">
                </div>
                <div class="text-white font-mono text-sm mb-1">${file.name}</div>
                <div class="text-accent-green font-bold">${result.prediction.toUpperCase()}</div>
                <div class="text-medical-200 text-sm">${result.confidence}</div>
                <button onclick="exportSingleReport('${file.name}', ${JSON.stringify(result).replace(/"/g, '&quot;')})" 
                        class="mt-2 w-full px-3 py-1 bg-medical-600 text-white rounded text-sm hover:bg-medical-700 transition-colors">
                    Export Report
                </button>
            `;
            
            container.appendChild(resultDiv);
        }

        function closeBatchModal() {
            document.getElementById('batch-modal').classList.add('hidden');
            document.getElementById('batch-input').value = '';
            batchFiles = [];
        }

        // ===== GALLERY SYSTEM =====
        function loadGallery() {
            const galleryData = {
                'mel': {
                    name: 'Melanoma',
                    description: 'Malignant skin tumor arising from melanocytes. Most dangerous form of skin cancer.',
                    characteristics: 'Asymmetry, Border irregularity, Color variation, Diameter >6mm, Evolving',
                    prevalence: '1.7% of skin lesions',
                    prognosis: 'Good if caught early, poor if metastasized',
                    treatment: 'Surgical excision, immunotherapy, targeted therapy'
                },
                'bcc': {
                    name: 'Basal Cell Carcinoma',
                    description: 'Most common skin cancer, rarely metastasizes but locally invasive.',
                    characteristics: 'Pearl-like appearance, rolled borders, central ulceration',
                    prevalence: '18.2% of skin lesions',
                    prognosis: 'Excellent with treatment',
                    treatment: 'Surgical excision, Mohs surgery, topical treatments'
                },
                'akiec': {
                    name: 'Actinic Keratoses',
                    description: 'Pre-cancerous lesions caused by sun damage, may progress to SCC.',
                    characteristics: 'Rough, scaly patches on sun-exposed areas',
                    prevalence: '12.8% of skin lesions',
                    prognosis: '5-10% risk of progression to SCC',
                    treatment: 'Cryotherapy, topical 5-FU, photodynamic therapy'
                },
                'bkl': {
                    name: 'Benign Keratosis',
                    description: 'Benign skin growth including seborrheic keratoses and solar lentigines.',
                    characteristics: 'Well-demarcated, waxy, "stuck-on" appearance',
                    prevalence: '27.4% of skin lesions',
                    prognosis: 'Benign, no malignant potential',
                    treatment: 'Usually no treatment needed, cosmetic removal if desired'
                },
                'nv': {
                    name: 'Melanocytic Nevi',
                    description: 'Common benign melanocytic lesions (moles).',
                    characteristics: 'Uniform color, symmetric, smooth borders',
                    prevalence: '33.1% of skin lesions',
                    prognosis: 'Benign, very low malignant potential',
                    treatment: 'Monitoring, excision if changes occur'
                },
                'df': {
                    name: 'Dermatofibroma',
                    description: 'Benign fibrous nodules often resulting from minor trauma.',
                    characteristics: 'Firm, dome-shaped, often darker in center',
                    prevalence: '4.2% of skin lesions',
                    prognosis: 'Benign, stable over time',
                    treatment: 'Usually observation, surgical excision if symptomatic'
                },
                'vasc': {
                    name: 'Vascular Lesions',
                    description: 'Benign vascular proliferations including hemangiomas and angiokeratomas.',
                    characteristics: 'Red to purple color, may be raised or flat',
                    prevalence: '2.6% of skin lesions',
                    prognosis: 'Benign, may involute spontaneously',
                    treatment: 'Observation, laser therapy, surgical excision'
                }
            };

            const container = document.getElementById('gallery-grid');
            container.innerHTML = '';
            
            Object.entries(galleryData).forEach(([key, data]) => {
                const card = document.createElement('div');
                card.className = 'bg-lab-700/30 rounded-2xl overflow-hidden glass-morphism border border-medical-400/20 hover:border-medical-400 transition-all duration-300';
                
                card.innerHTML = `
                    <div class="h-48 bg-gradient-to-br from-lab-600 to-lab-800 flex items-center justify-center">
                        <div class="text-center text-medical-200">
                            <span class="material-icons text-6xl mb-2">image</span>
                            <div class="font-mono text-2xl font-bold">${key.toUpperCase()}</div>
                        </div>
                    </div>
                    <div class="p-6">
                        <h3 class="text-white text-xl font-semibold mb-2">${data.name}</h3>
                        <p class="text-medical-200 text-sm mb-4 leading-relaxed">${data.description}</p>
                        
                        <div class="space-y-3">
                            <div>
                                <div class="text-white font-mono text-xs mb-1">CHARACTERISTICS</div>
                                <div class="text-medical-200 text-xs">${data.characteristics}</div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <div class="text-white font-mono text-xs mb-1">PREVALENCE</div>
                                    <div class="text-accent-green text-xs font-bold">${data.prevalence}</div>
                                </div>
                                <div>
                                    <div class="text-white font-mono text-xs mb-1">PROGNOSIS</div>
                                    <div class="text-medical-200 text-xs">${data.prognosis.split(',')[0]}</div>
                                </div>
                            </div>
                            
                            <div>
                                <div class="text-white font-mono text-xs mb-1">TREATMENT</div>
                                <div class="text-medical-200 text-xs">${data.treatment}</div>
                            </div>
                        </div>
                        
                        <button onclick="useAsExample('${key}')" 
                                class="mt-4 w-full px-4 py-2 bg-medical-600 text-white rounded-lg hover:bg-medical-700 transition-colors flex items-center justify-center space-x-2">
                            <span class="material-icons text-sm">play_arrow</span>
                            <span>Try Example</span>
                        </button>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        function useAsExample(classType) {
            // This would normally load an actual example image
            showError('Example images would be loaded from the server in a production environment');
            showView('upload');
        }

        // ===== HISTORY SYSTEM =====
        function saveToHistory(result, file) {
            const historyItem = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                filename: file.name,
                prediction: result.prediction,
                confidence: result.confidence,
                description: result.description,
                probabilities: result.probabilities,
                image: result.image
            };
            
            analysisHistory.unshift(historyItem);
            
            // Keep only last 50 analyses
            if (analysisHistory.length > 50) {
                analysisHistory = analysisHistory.slice(0, 50);
            }
            
            localStorage.setItem('analysisHistory', JSON.stringify(analysisHistory));
        }

        function loadHistory() {
            const container = document.getElementById('history-list');
            container.innerHTML = '';
            
            if (analysisHistory.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-20 h-20 mx-auto mb-4 bg-lab-600 rounded-full flex items-center justify-center">
                            <span class="material-icons text-medical-300 text-3xl">history</span>
                        </div>
                        <div class="text-medical-200 text-lg">No analysis history</div>
                        <div class="text-medical-400 text-sm mt-2">Your previous analyses will appear here</div>
                    </div>
                `;
                return;
            }
            
            analysisHistory.forEach(item => {
                const historyCard = document.createElement('div');
                historyCard.className = 'bg-lab-700/30 rounded-2xl p-6 glass-morphism border border-medical-400/20 flex items-center space-x-6';
                
                const timestamp = new Date(item.timestamp).toLocaleString();
                
                historyCard.innerHTML = `
                    <div class="w-24 h-24 rounded-xl overflow-hidden flex-shrink-0">
                        <img src="data:image/png;base64,${item.image}" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-white font-semibold">${item.filename}</h3>
                            <div class="text-medical-300 text-sm font-mono">${timestamp}</div>
                        </div>
                        <div class="flex items-center space-x-4 mb-2">
                            <div class="text-accent-green font-bold font-mono">${item.prediction.toUpperCase()}</div>
                            <div class="text-white font-mono">${item.confidence}</div>
                        </div>
                        <div class="text-medical-200 text-sm">${item.description}</div>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <button onclick="reanalyze(${item.id})" 
                                class="px-4 py-2 bg-medical-600 text-white rounded-lg hover:bg-medical-700 transition-colors flex items-center space-x-2">
                            <span class="material-icons text-sm">refresh</span>
                            <span>Reanalyze</span>
                        </button>
                        <button onclick="provideFeedback(${item.id})" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-2">
                            <span class="material-icons text-sm">feedback</span>
                            <span>Feedback</span>
                        </button>
                        <button onclick="exportReport(${item.id})" 
                                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center space-x-2">
                            <span class="material-icons text-sm">download</span>
                            <span>Report</span>
                        </button>
                    </div>
                `;
                
                container.appendChild(historyCard);
            });
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all analysis history?')) {
                analysisHistory = [];
                localStorage.removeItem('analysisHistory');
                loadHistory();
            }
        }

        function exportHistory() {
            const dataStr = JSON.stringify(analysisHistory, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'ham10k_analysis_history.json';
            link.click();
        }

        // ===== FEEDBACK SYSTEM =====
        function provideFeedback(itemId) {
            const item = analysisHistory.find(h => h.id === itemId);
            if (!item) return;
            
            const correctClass = prompt(`Provide correct classification for ${item.filename}:\nCurrent prediction: ${item.prediction}\n\nEnter correct class (mel, bcc, akiec, bkl, nv, df, vasc):`);
            
            if (correctClass && ['mel', 'bcc', 'akiec', 'bkl', 'nv', 'df', 'vasc'].includes(correctClass.toLowerCase())) {
                const feedback = {
                    id: itemId,
                    filename: item.filename,
                    predicted: item.prediction,
                    corrected: correctClass.toLowerCase(),
                    timestamp: new Date().toISOString(),
                    confidence: item.confidence
                };
                
                // Store feedback (in production, send to server)
                let feedbackData = JSON.parse(localStorage.getItem('feedbackData') || '[]');
                feedbackData.push(feedback);
                localStorage.setItem('feedbackData', JSON.stringify(feedbackData));
                
                showError('Thank you for your feedback! This will help improve the model.');
            }
        }

        // ===== THEME SYSTEM =====
        function toggleTheme() {
            // Theme switching would be implemented here
            showError('Theme switching feature coming soon!');
        }

        function toggleSettings() {
            showError('Advanced settings panel coming soon!');
        }

        // ===== METRICS LOADING =====
        function loadMetrics() {
            // Load confusion matrix and performance charts
            setTimeout(() => {
                createMetricsCharts();
            }, 100);
        }

        function createMetricsCharts() {
            // Mock performance data (in production, fetch from server)
            const performanceData = {
                accuracy: [0.91, 0.92, 0.94, 0.94, 0.942],
                precision: [0.89, 0.91, 0.92, 0.93, 0.928],
                recall: [0.88, 0.90, 0.91, 0.91, 0.915],
                f1Score: [0.885, 0.905, 0.915, 0.920, 0.921]
            };
            
            // Per-class performance chart would be created here
            // ROC curves would be created here
            // Confusion matrix heatmap would be created here
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize navigation
            showView('upload');
            
            // Set up navigation styles
            const style = document.createElement('style');
            style.textContent = `
                .nav-btn {
                    transition: all 0.2s ease;
                }
                .nav-btn.active {
                    background-color: rgb(14, 165, 233);
                    color: white;
                }
                .nav-btn:not(.active) {
                    color: rgb(148, 163, 184);
                }
                .nav-btn:not(.active):hover {
                    color: white;
                    background-color: rgb(71, 85, 105);
                }
            `;
            document.head.appendChild(style);
        });
        
        // ===== GALLERY FUNCTIONS =====
        
        async function loadGalleryExamples() {
            try {
                // Fetch examples from backend API
                const response = await fetch('/gallery/examples');
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error('Failed to load gallery examples');
                }
                
                const examples = data.examples;
                const galleryGrid = document.getElementById('gallery-grid');
                
                galleryGrid.innerHTML = examples.map(example => `
                    <div class="gallery-item bg-white rounded-lg overflow-hidden shadow-md hover:shadow-lg transition-all duration-300 cursor-pointer"
                         onclick="selectGalleryExample('${example.id}')">
                        <div class="aspect-square bg-gray-200 relative overflow-hidden">
                            <img src="${example.image}" 
                                 alt="${example.title}"
                                 class="w-full h-full object-cover"
                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjI0IiBoZWlnaHQ9IjIyNCIgdmlld0JveD0iMCAwIDIyNCAyMjQiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjIyNCIgaGVpZ2h0PSIyMjQiIGZpbGw9IiNGM0Y0RjYiLz48dGV4dCB4PSIxMTIiIHk9IjEyMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM2Mzc0OEIiPkV4YW1wbGUgSW1hZ2U8L3RleHQ+PC9zdmc+'">
                            <div class="absolute top-2 right-2">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${getRiskBadgeClass(example.risk_level)}">
                                    ${example.risk_level}
                                </span>
                            </div>
                        </div>
                        <div class="p-4">
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">${example.title}</h3>
                            <p class="text-sm text-gray-600 mb-3">${example.description}</p>
                            <div class="flex flex-wrap gap-1">
                                ${example.characteristics.slice(0, 3).map(char => 
                                    `<span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded">${char}</span>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading gallery examples:', error);
                showError('Failed to load gallery examples');
            }
        }
        
        function getRiskBadgeClass(riskLevel) {
            switch (riskLevel) {
                case 'HIGH': return 'bg-red-500 text-white';
                case 'MODERATE': return 'bg-yellow-500 text-white';
                case 'LOW': return 'bg-green-500 text-white';
                default: return 'bg-gray-500 text-white';
            }
        }
        
        async function selectGalleryExample(exampleId) {
            try {
                // Get example data
                const response = await fetch('/gallery/examples');
                const data = await response.json();
                const example = data.examples.find(ex => ex.id === exampleId);
                
                if (!example) {
                    throw new Error('Example not found');
                }
                
                // Load the image and analyze it
                const imageResponse = await fetch(example.image);
                const imageBlob = await imageResponse.blob();
                
                // Create a file object from the blob
                const file = new File([imageBlob], `${example.class}_example.jpg`, { type: 'image/jpeg' });
                selectedFile = file;
                
                // Update UI to show selected image
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('preview-image');
                    const metadata = document.getElementById('image-metadata');
                    
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    metadata.textContent = `${file.name} â€¢ Example Image â€¢ ${example.title}`;
                    
                    document.getElementById('upload-content').classList.add('hidden');
                    document.getElementById('image-preview').classList.remove('hidden');
                    document.getElementById('analyze-btn').disabled = false;
                    
                    // Switch to upload view to show the selected example
                    showUploadView();
                    
                    // Announce to screen reader
                    announceToScreenReader(`Selected example: ${example.title}. Ready for analysis.`);
                };
                reader.readAsDataURL(file);
                
            } catch (error) {
                console.error('Error selecting gallery example:', error);
                showError('Failed to load gallery example');
            }
        }
        
        // Initialize gallery when switching to gallery view
        function showGalleryView() {
            hideAllViews();
            document.getElementById('gallery-view').classList.remove('hidden');
            updateNavigation('gallery');
            loadGalleryExamples(); // Load examples when showing gallery
        }
        
        // ===== HISTORY FUNCTIONS =====
        
        function saveToHistory(result, file) {
            try {
                let history = JSON.parse(localStorage.getItem('analysisHistory') || '[]');
                
                const historyItem = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    filename: file.name,
                    predicted_class: result.prediction,
                    confidence: result.confidence,
                    description: result.description,
                    risk_level: result.risk_assessment?.level || 'UNKNOWN',
                    image_thumbnail: result.image // Store base64 thumbnail
                };
                
                // Add to beginning of array (most recent first)
                history.unshift(historyItem);
                
                // Keep only last 50 items
                history = history.slice(0, 50);
                
                localStorage.setItem('analysisHistory', JSON.stringify(history));
                
            } catch (error) {
                console.error('Error saving to history:', error);
            }
        }
        
        function loadAnalysisHistory() {
            try {
                const history = JSON.parse(localStorage.getItem('analysisHistory') || '[]');
                const historyContainer = document.getElementById('history-list');
                
                if (history.length === 0) {
                    historyContainer.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="material-icons text-6xl mb-4">history</i>
                            <p class="text-lg">No analysis history yet</p>
                            <p class="text-sm">Your previous analyses will appear here</p>
                        </div>
                    `;
                    return;
                }
                
                historyContainer.innerHTML = history.map(item => `
                    <div class="history-item bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition-shadow duration-300">
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                <img src="data:image/png;base64,${item.image_thumbnail}" 
                                     alt="Analysis thumbnail"
                                     class="w-16 h-16 rounded object-cover">
                            </div>
                            <div class="flex-grow">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="text-lg font-semibold text-gray-900">${item.predicted_class.toUpperCase()}</h3>
                                    <span class="px-2 py-1 text-xs font-semibold rounded ${getRiskBadgeClass(item.risk_level)}">
                                        ${item.risk_level}
                                    </span>
                                </div>
                                <p class="text-sm text-gray-600 mb-2">${item.description}</p>
                                <div class="flex items-center justify-between text-xs text-gray-500">
                                    <span>${item.filename}</span>
                                    <span>${new Date(item.timestamp).toLocaleString()}</span>
                                </div>
                                <div class="mt-2">
                                    <div class="text-sm font-medium">Confidence: ${item.confidence}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading history:', error);
                showError('Failed to load analysis history');
            }
        }
        
        function clearHistory() {
            if (confirm('Are you sure you want to clear all analysis history?')) {
                localStorage.removeItem('analysisHistory');
                loadAnalysisHistory();
                showError('Analysis history cleared');
            }
        }
        
        function showHistoryView() {
            hideAllViews();
            document.getElementById('history-view').classList.remove('hidden');
            updateNavigation('history');
            loadAnalysisHistory(); // Load history when showing history view
        }
        
        // ===== METRICS FUNCTIONS =====
        
        async function loadMetrics() {
            try {
                const response = await fetch('/metrics/model-performance');
                const metrics = await response.json();
                
                // Update overall metrics
                updateOverallMetrics(metrics);
                
                // Create charts
                createConfusionMatrixChart(metrics.confusion_matrix_data);
                createTrainingHistoryChart(metrics.training_history);
                createPerClassChart(metrics.per_class_metrics);
                
                // Load feedback stats
                const feedbackResponse = await fetch('/feedback/stats');
                const feedbackStats = await feedbackResponse.json();
                updateFeedbackStats(feedbackStats);
                
            } catch (error) {
                console.error('Error loading metrics:', error);
                showError('Failed to load model metrics');
            }
        }
        
        function updateOverallMetrics(metrics) {
            document.getElementById('overall-accuracy').textContent = (metrics.overall_accuracy * 100).toFixed(1) + '%';
            document.getElementById('sensitivity').textContent = (metrics.sensitivity * 100).toFixed(1) + '%';
            document.getElementById('specificity').textContent = (metrics.specificity * 100).toFixed(1) + '%';
            document.getElementById('f1-score').textContent = (metrics.f1_score * 100).toFixed(1) + '%';
        }
        
        function updateFeedbackStats(stats) {
            document.getElementById('total-feedback').textContent = stats.total_feedback;
            document.getElementById('user-accuracy').textContent = (stats.accuracy * 100).toFixed(1) + '%';
            
            const feedbackChartContainer = document.getElementById('feedback-chart');
            // Create simple feedback visualization
            feedbackChartContainer.innerHTML = `
                <div class="space-y-2">
                    ${Object.entries(stats.class_accuracy || {}).map(([cls, data]) => `
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium">${cls.toUpperCase()}</span>
                            <div class="flex items-center space-x-2">
                                <div class="w-24 bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-500 h-2 rounded-full" style="width: ${(data.accuracy * 100).toFixed(0)}%"></div>
                                </div>
                                <span class="text-sm text-gray-600">${(data.accuracy * 100).toFixed(0)}%</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function showMetricsView() {
            hideAllViews();
            document.getElementById('metrics-view').classList.remove('hidden');
            updateNavigation('metrics');
            loadMetrics(); // Load metrics when showing metrics view
        }
        
        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize mobile optimizations
            adjustForMobile();
        });
    </script>
</body>
</html>